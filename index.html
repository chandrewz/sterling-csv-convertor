<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Required meta tags always come first -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta http-equiv="x-ua-compatible" content="ie=edge">

		<link rel="stylesheet" href="https://bootswatch.com/cosmo/bootstrap.min.css">
		<link rel="stylesheet" href="https://rawgit.com/jaysalvat/ezdz/master/dist/jquery.ezdz.min.css">

		<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
		<script src="https://rawgit.com/jaysalvat/ezdz/master/dist/jquery.ezdz.min.js"></script>
	</head>

	<body>
		
		<div class="well bs-component">
			<h3>a CSV helper for sn-fg</h3>
			<h4>Step 1: File name. Step 2: Reply to. Step 3: Upload file.</h4>
			<div class="form-group">
				<label>File Name</label>
				<input type="text" id="file-name" placeholder="File Name (School District)" class="form-control">
			</div>
			<div class="form-group">
				<label>Reply To</label>
				<select id="reply" class="form-control">
					<option></option>
					<option>hayden@s-nfg.com</option>
					<option>ethan@s-nfg.com</option>
					<option>rory@s-nfg.com</option>
					<option>Madison@s-nfg.com</option>
					<option>brody@s-nfg.com</option>
				</select>
			</div>
			<div class="form-group">
				<input type="file" id="file">
			</div>
			<div class="form-group">
				<a id="download" download="somedata.csv" href="data:application/csv;charset=utf-8,Col1%2CCol2%2CCol3%0AVal1%2CVal2%2CVal3%0AVal11%2CVal22%2CVal33%0AVal111%2CVal222%2Candrew@planmyretirement.com" class="btn btn-primary hidden">Download</a>
			</div>
		</div>
	</body>

	<script>
		$(document).ready(function() {

			$('input[type="file"]').ezdz();

			$('#file').change(function(e) {
				var file = e.target.files[0];
				var papa = Papa.parse(file, {
					header: false,
					dynamicTyping: true,
					complete: function(results) {
						// console.log(results.data)

						// replace column headers
						for (var i in results.data[0]) {
							if (results.data[0][i] == 'First Name') {
								results.data[0][i] = 'First';
							}
							else if (results.data[0][i] == 'Last Name') {
								results.data[0][i] = 'Last';
							} else if (results.data[0][i] == 'School District') {
								results.data[0][i] = 'School';
							}

							// track email index
							if (results.data[0][i] == 'Email') {
								var emailIndex = i;
							}
						}

						// clone email column
						results.data[0].push('Mail');
						for (var i = 1; i < results.data.length; i++) {
							results.data[i].push(results.data[i][emailIndex]);
						}

						// if reply is set, add reply column
						console.log($('#reply').val().length);
						if ($('#reply').val().length > 0) {
							results.data[0].push('Reply');
							for (var i = 1; i < results.data.length; i++) {
								results.data[i].push($('#reply').val());
							}
						}

						// console.log(results.data)

						var unparsed = Papa.unparse(results.data);

						// console.log(unparsed);
						// console.log(unparsed.replace(/,/g, '%2C').replace(/(?:\r\n|\r|\n)/g, '%0D%0A'))
						var csvData = new Blob([unparsed], { type: 'text/csv' }); 

						// update download button & file name
						var today = new Date();
						var dateString = (today.getMonth() + 1) + '-' + today.getDate() + '-' + today.getFullYear();
						$('#download').attr({
							download: $('#file-name').val() + ' ' + dateString + '.csv',
							href: URL.createObjectURL(csvData),
							target: '_blank'
						}).text(
							'Download: ' + $('#file-name').val() + ' ' + dateString
						).removeClass('hidden');
					}
				});
			});
		});
	</script>

</html>